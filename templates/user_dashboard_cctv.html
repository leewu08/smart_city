{% extends "base.html" %}
{% block title %} CCTV í˜ì´ì§€ {% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #cctv-map { 
        height: 500px; 
        width: 100%; 
    }
    .cctv-list {
        max-height: 500px;
        overflow-y: auto;
    }
    .cctv-item {
        cursor: pointer;
        padding: 10px;
        border-bottom: 1px solid #eee;
    }
    .cctv-item:hover {
        background-color: #f0f0f0;
    }
    
    .cctv-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    .cctv-stream {
        width: 100%;
        max-width: 800px;
    }
    .cctv-info {
        margin-top: 20px;
    }
    #video-stream {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>ğŸ“¹ {{ camera.location }} CCTV</h1>
    <div class="cctv-container">
        <div class="cctv-stream">
            <img id="video-stream" src="http://{{camera.cctv_ip}}:5000/stream" alt="CCTV Stream">
        </div>
        <div class="cctv-info">
            <h2>ì‹¤ì‹œê°„ ì˜ìƒ ìŠ¤íŠ¸ë¦¬ë° ì¤‘...</h2>
            <p>í•´ë‹¹ CCTVëŠ” {{ camera.location }} ìœ„ì¹˜ì—ì„œ {{ camera.purpose}}ë¥¼ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì¤‘ì…ë‹ˆë‹¤.</p>
            <p id="safety-status">ë°ì´í„° ë¡œë“œ ì¤‘...</p>
            <p id="temperature-info">ì„¼ì„œ ë°ì´í„° ë¡œë“œ ì¤‘...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function fetchSensorData() {
    fetch('/api')  // Flask API í˜¸ì¶œ
        .then(response => response.json())
        .then(data => {
            console.log("ğŸ“© ë°›ì€ ë°ì´í„°:", data);

            // camera.purpose ê°’ ê°€ì ¸ì˜¤ê¸°
            let purpose = "{{ camera.purpose }}";  // 'ë„ë¡œ' ë˜ëŠ” 'ì¸ë„'

            // ID í•„í„°ë§
            let isValidData = false;
            if ((purpose === "ë„ë¡œ" && data.ID == "1") || 
                (purpose === "ì¸ë„" && data.ID == "2")) {
                isValidData = true;
            }

            if (!isValidData) {
                console.warn("âš ï¸ í•´ë‹¹ ëª©ì ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                document.getElementById("safety-status").innerHTML = "ì„¼ì„œ ë°ì´í„° ì—†ìŒ";
                document.getElementById("temperature-info").innerHTML = "";
                return;
            }

            // ì•ˆì „ ìƒíƒœ ì—…ë°ì´íŠ¸
            let safetyStatus = document.getElementById("safety-status");
            if (data["Switch State"] == "1") {
                safetyStatus.innerHTML = "ğŸ”¹ í˜„ì¬ ê°€ë¡œë“± ì£¼ë³€ì€ ì•ˆì „í•©ë‹ˆë‹¤.";
            } else {
                safetyStatus.innerHTML = "âš ï¸ ê¸´ê¸‰ ìƒí™©! SOS ë²„íŠ¼ì´ ëˆŒë ¸ìŠµë‹ˆë‹¤!";
            }

            // ì˜¨ìŠµë„ ì •ë³´ ì—…ë°ì´íŠ¸ (undefined ê°’ ì²´í¬ í›„ í‘œì‹œ)
            let temperatureInfo = document.getElementById("temperature-info");
            let temperature = data.Temperature;
            let humidity = data.Humidity;
            let heatIndex = data["Heat Index"];

            if (temperature !== undefined && humidity !== undefined && heatIndex !== undefined) {
                temperatureInfo.innerHTML = `í˜„ì¬ {{camera.location}}ì˜ ê¸°ì˜¨ì€ ${temperature}, 
                                             ìŠµë„ëŠ” ${humidity}, 
                                             ì²´ê°ì˜¨ë„ëŠ” ${heatIndex} ì…ë‹ˆë‹¤.`;
            } else {
                temperatureInfo.innerHTML = "";  // ê°’ì´ ì—†ìœ¼ë©´ ì•„ì˜ˆ í‘œì‹œí•˜ì§€ ì•ŠìŒ
            }
        })
        .catch(error => {
            console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
            document.getElementById("safety-status").innerHTML = "ì„¼ì„œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
            document.getElementById("temperature-info").innerHTML = "";
        });
}

// 2ì´ˆë§ˆë‹¤ ë°ì´í„° ê°±ì‹ 
setInterval(fetchSensorData, 2000);

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
fetchSensorData();

</script>
{% endblock %}
